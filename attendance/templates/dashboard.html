{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - StaffTrack {% endblock %}

{% block extra_css %}
<style>
    .welcome-card {
        background: linear-gradient(135deg, #4a6fa5 60%, #3a5a80 100%);
        color: white;
        border-radius: 1rem;
        overflow: hidden;
        position: relative;
        z-index: 1;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
    }
    .welcome-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        z-index: -1;
    }
    .welcome-content {
        position: relative;
        z-index: 2;
        padding: 2rem;
    }
    .card {
        background: rgba(255,255,255,0.92);
        border-radius: 1rem;
        box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.10);
        border: none;
    }
    .card-header, .card-footer {
        background: transparent !important;
    }
    .stats-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
        border-radius: 0.75rem;
        overflow: hidden;
        height: 100%;
    }
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
    .stats-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }
    .stats-number {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0.5rem 0;
    }
    .stats-label {
        font-size: 0.9rem;
        color: var(--gray-600);
        margin: 0;
    }
    .quick-actions .btn {
        border-radius: 0.75rem;
        padding: 0.75rem 1.25rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    .quick-actions .btn i {
        margin-right: 0.5rem;
    }
    .recent-activity {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .activity-item {
        padding: 1rem 0;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        align-items: flex-start;
    }
    .activity-item:last-child {
        border-bottom: none;
    }
    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: rgba(74, 111, 165, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        color: var(--primary-color);
        flex-shrink: 0;
    }
    .activity-content {
        flex: 1;
    }
    .activity-time {
        font-size: 0.8rem;
        color: var(--gray-600);
        margin-top: 0.25rem;
    }
    
    /* Time Off Item Styles */
    .time-off-item {
        padding: 1rem;
        border-bottom: 1px solid var(--gray-200);
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .time-off-item:last-child {
        border-bottom: none;
    }
    
    .time-off-item:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    .time-off-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .time-off-details {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        padding: 0 0.5rem;
    }
    
    .time-off-item.expanded .time-off-details {
        max-height: 500px;
        padding: 1rem 0.5rem;
        border-top: 1px solid var(--gray-200);
        margin-top: 0.75rem;
    }
    
    .time-off-item .toggle-icon {
        transition: transform 0.3s;
    }
    
    .time-off-item.expanded .toggle-icon {
        transform: rotate(180deg);
    }
    
    /* Activity icon status colors */
    .activity-icon.late {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }
    
    .activity-icon.on-time {
        background-color: rgba(25, 135, 84, 0.1);
        color: #198754;
    }
    
    .activity-icon.absent {
        background-color: rgba(108, 117, 125, 0.1);
        color: #6c757d;
    }
    
    /* Todo List Styles */
    .todo-container {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        flex-wrap: wrap;
    }
    
    .todo-column {
        flex: 1;
        min-width: 280px;
        background: white;
        border-radius: 0.75rem;
        padding: 1rem;
        box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.10);
    }
    
    /* Responsive Styles for Todo List */
    @media (max-width: 992px) {
        .todo-container {
            flex-direction: column;
        }
        
        .todo-column {
            width: 100%;
            min-width: 100%;
        }
    }
    
    .todo-column-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid;
    }
    
    .todo-column.todo-todo .todo-column-header {
        border-color: #0d6efd;
    }
    
    .todo-column.todo-ongoing .todo-column-header {
        border-color: #ffc107;
    }
    
    .todo-column.todo-done .todo-column-header {
        border-color: #198754;
    }
    
    .todo-column-title {
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .todo-count {
        background: rgba(0,0,0,0.1);
        padding: 0.25rem 0.5rem;
        border-radius: 0.5rem;
        font-size: 0.85rem;
    }
    
    .todo-item {
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        cursor: move;
        transition: all 0.3s ease;
        border-left: 3px solid;
    }
    
    .todo-column.todo-todo .todo-item {
        border-left-color: #0d6efd;
    }
    
    .todo-column.todo-ongoing .todo-item {
        border-left-color: #ffc107;
    }
    
    .todo-column.todo-done .todo-item {
        border-left-color: #198754;
    }
    
    .todo-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .todo-item-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #2c3e50;
    }
    
    .todo-item-description {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 0.75rem;
    }
    
    .todo-item-dates {
        font-size: 0.75rem;
        color: #6c757d;
        margin-bottom: 0.75rem;
    }
    
    .todo-item-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .todo-item-actions .btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
    }
    
    .add-todo-btn {
        width: 100%;
        border: 2px dashed #dee2e6;
        background: transparent;
        color: #6c757d;
        padding: 0.75rem;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .add-todo-btn:hover {
        border-color: #0d6efd;
        color: #0d6efd;
        background: rgba(13, 110, 253, 0.05);
    }
    
    .todo-empty {
        text-align: center;
        color: #6c757d;
        padding: 2rem 1rem;
        font-size: 0.9rem;
    }
    
    /* Duty Delegation Styles */
    .priority-badge {
        padding: 0.35rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .priority-low {
        background-color: rgba(13, 110, 253, 0.1);
        color: #0d6efd;
    }
    
    .priority-medium {
        background-color: rgba(255, 193, 7, 0.1);
        color: #ffc107;
    }
    
    .priority-high {
        background-color: rgba(255, 87, 34, 0.1);
        color: #ff5722;
    }
    
    .priority-urgent {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .duty-status-pending {
        background-color: rgba(108, 117, 125, 0.1);
        color: #6c757d;
    }
    
    .duty-status-in-progress {
        background-color: rgba(13, 110, 253, 0.1);
        color: #0d6efd;
    }
    
    .duty-status-completed {
        background-color: rgba(25, 135, 84, 0.1);
        color: #198754;
    }
    
    .duty-status-overdue {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }
    
    /* General Mobile Responsive Styles */
    @media (max-width: 768px) {
        .welcome-content {
            padding: 1.5rem;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .stats-number {
            font-size: 1.5rem;
        }
        
        .stats-label {
            font-size: 0.85rem;
        }
        
        .todo-column {
            padding: 0.75rem;
        }
        
        .todo-column-title {
            font-size: 1rem;
        }
        
        .todo-item {
            padding: 0.75rem;
        }
        
        .table-responsive {
            font-size: 0.875rem;
        }
        
        .btn {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }
    }
    
    @media (max-width: 576px) {
        .welcome-content {
            padding: 1rem;
        }
        
        .welcome-card h2 {
            font-size: 1.5rem;
        }
        
        .stats-card {
            margin-bottom: 1rem;
        }
        
        .todo-container {
            margin-top: 1rem;
            gap: 0.75rem;
        }
        
        .card {
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    <!-- Welcome Card -->
    <div class="welcome-card mb-4">
        <div class="welcome-content">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="mb-1">Welcome back, {{ user.first_name|default:user.username }}!</h2>
                    <p class="mb-0">{{ user_role }}{% if department %} • {{ department }}{% endif %}</p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <span class="badge bg-white text-primary px-3 py-2 rounded-pill">
                        <i class="fas fa-user-shield me-1"></i>
                        {% if is_staff %}
                            Administrator
                        {% else %}
                            {% if Intern %}
                                Intern
                            {% else %}
                                {% if Trainee %}
                                    Trainee
                                {% else %}
                                    {% if ITstudent %}
                                        ITstudent
                                    {% else %}
                                        Team Member
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    </span>

                </div>
            </div>
        </div>
    </div>

    {% if is_staff %}
    <!-- Staff Dashboard -->
    <div class="row g-4 mb-4">
        <!-- Stats Cards -->
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="stats-icon" style="background-color: rgba(220, 53, 69, 0.1); color: #dc3545;">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stats-number text-danger">{{ late_count|default:0 }}</div>
                    <p class="stats-label">Late Sign-Ins Today</p>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-danger bg-opacity-10 text-danger p-2 rounded">
                            <i class="fas fa-arrow-up me-1"></i> {{ late_count|default:0 }}
                        </span>
                        <span class="ms-2 small text-muted">today</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="stats-icon" style="background-color: rgba(25, 135, 84, 0.1); color: #198754;">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stats-number text-success">{{ on_time_percent|default:0 }}%</div>
                    <p class="stats-label">On-time Attendance</p>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-success bg-opacity-10 text-success p-2 rounded">
                            <i class="fas fa-arrow-up me-1"></i> {{ on_time_percent|default:0 }}%
                        </span>
                        <span class="ms-2 small text-muted">today</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="stats-icon" style="background-color: rgba(13, 110, 253, 0.1); color: #0d6efd;">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stats-number text-primary">{{ active_employees|default:0 }}</div>
                    <p class="stats-label">Active Employees</p>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-primary bg-opacity-10 text-primary p-2 rounded">
                            <i class="fas fa-arrow-up me-1"></i> {{ active_employees|default:0 }}
                        </span>
                        <span class="ms-2 small text-muted">last 30 days</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="stats-icon" style="background-color: rgba(255, 193, 7, 0.1); color: #ffc107;">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="stats-number text-warning">{{ pending_leaves|default:0 }}</div>
                    <p class="stats-label">Pending Leave Requests</p>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-warning bg-opacity-10 text-warning p-2 rounded">
                            <i class="fas fa-arrow-down me-1"></i> {{ pending_leaves|default:0 }}
                        </span>
                        <span class="ms-2 small text-muted">pending</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <div class="row g-4 mb-4">
            <!-- Duty Delegation Section -->
            <div class="col-lg-8">
                <div class="card h-100">
                    <div class="card-header bg-white border-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>Delegate Duties</h5>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#delegateDutyModal">
                                <i class="fas fa-plus me-1"></i>Assign New Duty
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Staff Member</th>
                                        <th>Duty/Task</th>
                                        <th>Priority</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="delegated-duties-list">
                                    {% for duty in delegated_duties %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="https://ui-avatars.com/api/?name={{ duty.assigned_to.get_full_name|default:duty.assigned_to.username|urlencode }}&background=4a6fa5&color=fff" class="rounded-circle me-2" width="32" height="32" alt="{{ duty.assigned_to.get_full_name|default:duty.assigned_to.username }}">
                                                <div>
                                                    {{ duty.assigned_to.get_full_name|default:duty.assigned_to.username }}
                                                    <div class="small text-muted">by {{ duty.assigned_by.get_full_name|default:duty.assigned_by.username }}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="fw-semibold">{{ duty.title }}</div>
                                            <div class="text-muted small">{{ duty.description|default:''|truncatewords:12 }}</div>
                                        </td>
                                        <td>
                                            <span class="priority-badge 
                                                {% if duty.priority == 'LOW' %}priority-low{% endif %}
                                                {% if duty.priority == 'MEDIUM' %}priority-medium{% endif %}
                                                {% if duty.priority == 'HIGH' %}priority-high{% endif %}
                                                {% if duty.priority == 'URGENT' %}priority-urgent{% endif %}">
                                                {{ duty.priority|title }}
                                            </span>
                                        </td>
                                        <td>{{ duty.due_date|date:"M d, Y"|default:'—' }}</td>
                                        <td>
                                            <span class="badge 
                                                {% if duty.status == 'Pending' %}duty-status-pending{% endif %}
                                                {% if duty.status == 'In Progress' %}duty-status-in-progress{% endif %}
                                                {% if duty.status == 'Completed' %}duty-status-completed{% endif %}
                                                {% if duty.status == 'Overdue' %}duty-status-overdue{% endif %}">
                                                {{ duty.status }}
                                            </span>
                                        </td>
                                        <td class="text-nowrap">
                                            <button class="btn btn-sm btn-outline-secondary" title="View"><i class="fas fa-eye"></i></button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            <i class="fas fa-clipboard-list fa-2x mb-2 d-block"></i>
                                            No delegated duties yet.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white border-0 text-center">
                        <a href="#" class="text-decoration-none">View All Delegated Duties <i class="fas fa-arrow-right ms-1"></i></a>
                    </div>
                </div>
            </div>
            <!-- Recent Activity -->
            <div class="col-lg-4 d-flex align-items-stretch">
                <div class="card w-100 h-100">
                    <div class="card-header bg-white border-0">
                        <h5 class="mb-0">Recent Activity</h5>
                    </div>
                    <div class="card-body p-0">
                        <ul class="recent-activity p-3">
                            {% for att in recent_attendance %}
                            <li class="activity-item">
                                <div class="activity-icon {% if att.sign_in and att.sign_in|time > '09:00:00' %}late{% elif att.sign_in %}on-time{% else %}absent{% endif %}">
                                {% if att.sign_in and att.sign_in|time > '09:00:00' %}
                                    <i class="fas fa-user-clock"></i>
                                {% elif att.sign_in %}
                                    <i class="fas fa-user-check"></i>
                                {% else %}
                                    <i class="fas fa-sign-out-alt"></i>
                                {% endif %}
                            </div>
                            <div class="activity-content">
                                <div class="d-flex justify-content-between">
                                    <strong>
                                        {% if att.sign_in and att.sign_in|time > '09:00:00' %}Late Arrival{% elif att.sign_in %}On Time{% else %}No Check-In{% endif %}
                                    </strong>
                                    <span class="text-muted small">{{ att.sign_in|time:"H:i A"|default:"--:--" }}</span>
                                </div>
                                <p class="mb-0 small">
                                    {{ att.user.get_full_name|default:att.user.username }}
                                    {% if att.sign_in and att.sign_in|time > '09:00:00' %}
                                        arrived late
                                    {% elif att.sign_in %}
                                        checked in
                                    {% else %}
                                        no check-in
                                    {% endif %}
                                </p>
                                <div class="activity-time">{{ att.date|date:"M d, Y" }}</div>
                            </div>
                        </li>
                        {% empty %}
                        <li class="activity-item text-muted">No recent activity.</li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="card-footer bg-white border-0 text-center">
                    <a href="#" class="text-decoration-none">View All Activity <i class="fas fa-arrow-right ms-1"></i></a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions & Recent Requests in one row -->
    <div class="row g-4">
        <!-- Quick Actions / Team Member Card -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <span class="badge bg-white text-primary px-3 py-2 rounded-pill">
                        <i class="fas fa-user-shield me-1"></i>
                        {% if is_staff %}
                            Administrator
                        {% elif user_role == "Intern" %}
                            Intern
                        {% elif user_role == "Trainee" %}
                            Trainee
                        {% elif user_role == "ITstudent" %}
                            ITstudent
                        {% else %}
                            Team Member
                        {% endif %}
                    </span>
                </div>
                <div class="col-md-6">
                    <a href="{% url 'attendance_list' %}" class="btn btn-outline-info w-100 py-3 mb-2">
                        <i class="fas fa-list-alt me-2"></i>View Attendance
                    </a>
                </div>
                <div class="col-md-6">
                    <a href="#" class="btn btn-outline-secondary w-100 py-3 mb-2">
                        <i class="fas fa-file-export me-2"></i>Export Report
                    </a>
                </div>
            </div>
        </div>
        <!-- Recent  Requests Card -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent  Requests</h5>
                    <a href="{% url 'all_time_off' %}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Employee</th>
                                    <th>Request Type</th>
                                    <th>Dates</th>
                                    <th>Status</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for leave in recent_leaves %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="https://ui-avatars.com/api/?name={{ leave.user.get_full_name|default:leave.user.username|urlencode }}&background=4a6fa5&color=fff" class="rounded-circle me-2" width="32" height="32" alt="{{ leave.user.get_full_name|default:leave.user.username }}">
                                            <div>{{ leave.user.get_full_name|default:leave.user.username }}</div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if leave.type == 'Remote Work' %}
                                            <span class="badge bg-info bg-opacity-10 text-info">Remote Work</span>
                                        {% else %}
                                            {{ leave.reason|truncatewords:3 }}
                                        {% endif %}
                                    </td>
                                    <td>{{ leave.start_date|date:"M d" }} - {{ leave.end_date|date:"M d" }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if leave.status == 'Pending' %}bg-warning bg-opacity-10 text-warning{% endif %}
                                            {% if leave.status == 'Approved' %}bg-success bg-opacity-10 text-success{% endif %}
                                            {% if leave.status == 'Rejected' %}bg-danger bg-opacity-10 text-danger{% endif %}">
                                            {{ leave.status }}
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        {% if is_staff and leave.status == 'Pending' %}
                                            <form method="post" action="{% url 'approve_leave_request' leave.id %}" style="display:inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-success btn-sm">Approve</button>
                                            </form>
                                            <form method="post" action="{% url 'reject_leave_request' leave.id %}" style="display:inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-danger btn-sm">Reject</button>
                                            </form>
                                        {% else %}
                                            <button class="btn btn-sm btn-link p-0" data-bs-toggle="tooltip" title="View Details">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="5" class="text-center text-muted">No recent requests.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% else %}
    <!-- Employee Dashboard -->
    <div class="row g-4">
        <!-- Welcome Card -->
        <div class="col-12">
            <div class="card bg-light border-0">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3 class="h4 mb-2">Welcome to Your Dashboard</h3>
                            <p class="text-muted mb-0">Check your attendance, request time off, and stay up to date with your schedule.</p>
                        </div>
                        <div class="col-md-4 text-md-end mt-3 mt-md-0">
                            <div class="d-flex flex-column">
                                <span class="badge bg-primary bg-opacity-10 text-primary p-2 mb-2">
                                    <i class="far fa-calendar-check me-1"></i> 
                                    {% now "F Y" %}
                                </span>
                                <div class="d-flex justify-content-md-end gap-2">
                                    <a href="{% url 'sign_in_out' %}" class="btn btn-primary">
                                        {% if show_sign_out %}
                                            <i class="fas fa-sign-out-alt me-1"></i> Sign Out
                                        {% else %}
                                            <i class="fas fa-sign-in-alt me-1"></i> Sign In
                                        {% endif %}
                                    </a>
                                    <a href="{% url 'leave_request' %}" class="btn btn-outline-primary">
                                        <i class="far fa-calendar-plus me-1"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="avatar avatar-lg bg-primary bg-opacity-10 text-primary rounded-circle mb-3">
                        <i class="fas fa-calendar-check fa-2x"></i>
                    </div>
                    <h3 class="mb-1">{{ days_worked|default:0 }}</h3>
                    <p class="text-muted mb-0">Days Worked This Month</p>
                    <div class="progress mt-3" style="height: 6px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: {{ days_worked_percent|default:0 }}%" aria-valuenow="{{ days_worked_percent|default:0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <p class="small text-muted mt-2 mb-0">of monthly target</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="avatar avatar-lg bg-warning bg-opacity-10 text-warning rounded-circle mb-3">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                    <h3 class="mb-1">{{ late_arrivals|default:0 }}</h3>
                    <p class="text-muted mb-0">Late Arrivals</p>
                    <div class="mt-3">
                        <span class="badge bg-warning bg-opacity-10 text-warning">
                        <i class="fas fa-arrow-down me-1"></i> {{ late_arrivals|default:0 }} this month
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="avatar avatar-lg bg-success bg-opacity-10 text-success rounded-circle mb-3">
                        <i class="fas fa-umbrella-beach fa-2x"></i>
                    </div>
                    <h3 class="mb-1">{{ vacation_days_left|default:0 }}</h3>
                    <p class="text-muted mb-0">Remaining Vacation Days</p>
                    <a href="{% url 'leave_request' %}" class="btn btn-sm btn-outline-success mt-3">
                        <i class="far fa-calendar-plus me-1"></i> Request Time Off
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0">Your Recent Activity</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Check In</th>
                                    <th>Check Out</th>
                                    <th>Total Hours</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for att in recent_user_attendance %}
                                <tr>
                                    <td>{{ att.date|date:"M d, Y" }}</td>
                                    <td>{{ att.sign_in|time:"h:i A"|default:"--:--" }}</td>
                                    <td>{{ att.sign_out|time:"h:i A"|default:"--:--" }}</td>
                                    <td>{{ att.duration_str|default:"--:--" }}</td>
                                    <td>
                                        {% if att.sign_in and att.sign_out %}
                                            {% if att.sign_in|time > '09:00:00' %}
                                                <span class="badge bg-warning bg-opacity-10 text-warning">Late</span>
                                            {% else %}
                                                <span class="badge bg-success bg-opacity-10 text-success">Completed</span>
                                            {% endif %}
                                        {% elif att.sign_in and not att.sign_out %}
                                            <span class="badge bg-info bg-opacity-10 text-info">Working</span>
                                        {% else %}
                                            <span class="badge bg-secondary bg-opacity-10 text-secondary">Day Off</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="5" class="text-center text-muted">No recent attendance records.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white border-0 text-center">
                    <a href="#" class="text-decoration-none">View Full Attendance History <i class="fas fa-arrow-right ms-1"></i></a>
                </div>
            </div>
        </div>
        
        <!-- Upcoming Time Off -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Upcoming Time Off</h5>
                    <a href="{% url 'leave_request' %}" class="btn btn-sm btn-outline-primary">Request</a>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for leave in upcoming_time_off %}
                        <div class="time-off-item" role="button" aria-expanded="false" aria-controls="leaveDetails{{ leave.id }}">
                            <div class="time-off-header">
                                <div class="d-flex align-items-center">
                                    <div class="avatar avatar-md 
                                        {% if leave.type == 'Remote Work' %}bg-info bg-opacity-10 text-info{% elif leave.status == 'Approved' %}bg-success bg-opacity-10 text-success{% elif leave.status == 'Pending' %}bg-warning bg-opacity-10 text-warning{% else %}bg-secondary bg-opacity-10 text-secondary{% endif %} rounded-circle me-3">
                                        {% if leave.type == 'Remote Work' %}
                                            <i class="fas fa-home"></i>
                                        {% else %}
                                            <i class="fas fa-umbrella-beach"></i>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <h6 class="mb-0">
                                            {% if leave.type == 'Remote Work' %}Remote Work{% else %}{{ leave.reason|truncatewords:3 }}{% endif %}
                                        </h6>
                                        <small class="text-muted">{{ leave.start_date|date:"M d, Y" }} - {{ leave.end_date|date:"M d, Y" }}</small>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="badge me-2
                                        {% if leave.type == 'Remote Work' %}bg-info bg-opacity-10 text-info{% elif leave.status == 'Approved' %}bg-success bg-opacity-10 text-success{% elif leave.status == 'Pending' %}bg-warning bg-opacity-10 text-warning{% else %}bg-secondary bg-opacity-10 text-secondary{% endif %}">
                                        {% if leave.type == 'Remote Work' %}Remote{% else %}{{ leave.status }}{% endif %}
                                    </span>
                                    <i class="fas fa-chevron-down toggle-icon text-muted"></i>
                                </div>
                            </div>
                            <div class="time-off-details" id="leaveDetails{{ leave.id }}">
                                <div class="mt-2 pt-2">
                                    <p class="mb-1"><strong>Type:</strong> {{ leave.get_type_display|default:leave.type }}</p>
                                    <p class="mb-1"><strong>Duration:</strong> {{ leave.days }} day{{ leave.days|pluralize }}</p>
                                    <p class="mb-0"><strong>Full Reason:</strong> {{ leave.reason }}</p>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted p-4">
                            No upcoming time off scheduled.
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer bg-white border-0 text-center">
                    <a href="{% url 'all_time_off' %}" class="text-decoration-none">View All Time Off <i class="fas fa-arrow-right ms-1"></i></a>
                </div>
            </div>
        </div>
        
        <!-- My Delegated Duties -->
        <div class="col-12">
            <div class="card h-100">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0"><i class="fas fa-briefcase me-2"></i>Your Delegated Duties</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Assigned By</th>
                                    <th>Duty/Task</th>
                                    <th>Priority</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for duty in my_duties %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="https://ui-avatars.com/api/?name={{ duty.assigned_by.get_full_name|default:duty.assigned_by.username|urlencode }}&background=4a6fa5&color=fff" class="rounded-circle me-2" width="32" height="32" alt="{{ duty.assigned_by.get_full_name|default:duty.assigned_by.username }}">
                                            <div>{{ duty.assigned_by.get_full_name|default:duty.assigned_by.username }}</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="fw-semibold">{{ duty.title }}</div>
                                        <div class="text-muted small">{{ duty.description|default:''|truncatewords:12 }}</div>
                                    </td>
                                    <td>
                                        <span class="priority-badge 
                                            {% if duty.priority == 'LOW' %}priority-low{% endif %}
                                            {% if duty.priority == 'MEDIUM' %}priority-medium{% endif %}
                                            {% if duty.priority == 'HIGH' %}priority-high{% endif %}
                                            {% if duty.priority == 'URGENT' %}priority-urgent{% endif %}">
                                            {{ duty.priority|title }}
                                        </span>
                                    </td>
                                    <td>{{ duty.due_date|date:"M d, Y"|default:'—' }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if duty.status == 'Pending' %}duty-status-pending{% endif %}
                                            {% if duty.status == 'In Progress' %}duty-status-in-progress{% endif %}
                                            {% if duty.status == 'Completed' %}duty-status-completed{% endif %}
                                            {% if duty.status == 'Overdue' %}duty-status-overdue{% endif %}">
                                            {{ duty.status }}
                                        </span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="fas fa-clipboard-list fa-2x mb-2 d-block"></i>
                                        No delegated duties for you yet.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Todo List Section (Available for both Admin and Users) -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>My To-Do List</h5>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTodoModal">
                            <i class="fas fa-plus me-1"></i>Add Task
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="todo-container">
                        <!-- To Do Column -->
                        <div class="todo-column todo-todo">
                            <div class="todo-column-header">
                                <div class="todo-column-title">
                                    <i class="fas fa-list"></i>
                                    To Do
                                    <span class="todo-count" id="todo-count">0</span>
                                </div>
                            </div>
                            <div id="todo-list" class="todo-items-container">
                                <div class="todo-empty">No tasks yet</div>
                            </div>
                        </div>
                        
                        <!-- Ongoing Column -->
                        <div class="todo-column todo-ongoing">
                            <div class="todo-column-header">
                                <div class="todo-column-title">
                                    <i class="fas fa-spinner"></i>
                                    Ongoing
                                    <span class="todo-count" id="ongoing-count">0</span>
                                </div>
                            </div>
                            <div id="ongoing-list" class="todo-items-container">
                                <div class="todo-empty">No ongoing tasks</div>
                            </div>
                        </div>
                        
                        <!-- Done Column -->
                        <div class="todo-column todo-done">
                            <div class="todo-column-header">
                                <div class="todo-column-title">
                                    <i class="fas fa-check-circle"></i>
                                    Done
                                    <span class="todo-count" id="done-count">0</span>
                                </div>
                            </div>
                            <div id="done-list" class="todo-items-container">
                                <div class="todo-empty">No completed tasks</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Todo Modal -->
<div class="modal fade" id="addTodoModal" tabindex="-1" aria-labelledby="addTodoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTodoModalLabel">Add New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTodoForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="todoTitle" class="form-label">Task Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="todoTitle" required placeholder="Enter task title">
                    </div>
                    <div class="mb-3">
                        <label for="todoDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="todoDescription" rows="3" placeholder="Enter task description"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addTodo()">Add Task</button>
            </div>
        </div>
    </div>
</div>

<!-- Delegate Duty Modal -->
<div class="modal fade" id="delegateDutyModal" tabindex="-1" aria-labelledby="delegateDutyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="delegateDutyModalLabel"><i class="fas fa-user-plus me-2"></i>Delegate New Duty</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="delegateDutyForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dutyStaffMember" class="form-label">Assign To <span class="text-danger">*</span></label>
                            <select class="form-select" id="dutyStaffMember" required>
                                <option value="">Select Staff Member...</option>
                                <!-- Staff members will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="dutyPriority" class="form-label">Priority <span class="text-danger">*</span></label>
                            <select class="form-select" id="dutyPriority" required>
                                <option value="">Select Priority...</option>
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                                <option value="Urgent">Urgent</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="dutyTitle" class="form-label">Duty/Task Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="dutyTitle" required placeholder="Enter duty title">
                    </div>
                    <div class="mb-3">
                        <label for="dutyDescription" class="form-label">Description <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="dutyDescription" rows="4" required placeholder="Describe the duty in detail..."></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dutyDueDate" class="form-label">Due Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="dutyDueDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="dutyDueTime" class="form-label">Due Time</label>
                            <input type="time" class="form-control" id="dutyDueTime">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="delegateDuty()">
                    <i class="fas fa-paper-plane me-1"></i>Assign Duty
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Time off expand/collapse functionality
    document.querySelectorAll('.time-off-item').forEach(item => {
        item.addEventListener('click', function() {
            this.classList.toggle('expanded');
            
            // Toggle aria-expanded for accessibility
            const isExpanded = this.classList.contains('expanded');
            this.setAttribute('aria-expanded', isExpanded);
            
            // If you want to close other open items when opening a new one
            if (isExpanded) {
                document.querySelectorAll('.time-off-item').forEach(otherItem => {
                    if (otherItem !== this && otherItem.classList.contains('expanded')) {
                        otherItem.classList.remove('expanded');
                        otherItem.setAttribute('aria-expanded', 'false');
                    }
                });
            }
        });
    });
});
</script>
<!-- Bootstrap 5 JS (required for collapse) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoA6DQD1P1L1QnYh6tY1QZ6V9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Fix for Bootstrap collapse not working on dynamically rendered elements
    // (re-initialize collapse for all .collapse elements)
    document.querySelectorAll('.collapse').forEach(function (el) {
        new bootstrap.Collapse(el, { toggle: false });
    });
    
    // Load todos on page load
    loadTodos();
});

// Todo List Functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function loadTodos() {
    fetch('{% url "get_todos" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderTodos(data.todos);
            }
        })
        .catch(error => {
            console.error('Error loading todos:', error);
        });
}

function renderTodos(todos) {
    const todoList = document.getElementById('todo-list');
    const ongoingList = document.getElementById('ongoing-list');
    const doneList = document.getElementById('done-list');
    
    // Clear existing content
    todoList.innerHTML = '';
    ongoingList.innerHTML = '';
    doneList.innerHTML = '';
    
    // Update counts
    document.getElementById('todo-count').textContent = todos.TODO.length;
    document.getElementById('ongoing-count').textContent = todos.ONGOING.length;
    document.getElementById('done-count').textContent = todos.DONE.length;
    
    // Render TODO items
    if (todos.TODO.length === 0) {
        todoList.innerHTML = '<div class="todo-empty">No tasks yet</div>';
    } else {
        todos.TODO.forEach(todo => {
            todoList.innerHTML += createTodoHTML(todo, 'TODO');
        });
    }
    
    // Render ONGOING items
    if (todos.ONGOING.length === 0) {
        ongoingList.innerHTML = '<div class="todo-empty">No ongoing tasks</div>';
    } else {
        todos.ONGOING.forEach(todo => {
            ongoingList.innerHTML += createTodoHTML(todo, 'ONGOING');
        });
    }
    
    // Render DONE items
    if (todos.DONE.length === 0) {
        doneList.innerHTML = '<div class="todo-empty">No completed tasks</div>';
    } else {
        todos.DONE.forEach(todo => {
            doneList.innerHTML += createTodoHTML(todo, 'DONE');
        });
    }
}

function createTodoHTML(todo, status) {
    let dateInfo = `<div class="todo-item-dates">
        <i class="far fa-calendar-plus"></i> Created: ${formatDate(todo.created_at)}`;
    
    if (todo.started_at) {
        dateInfo += `<br><i class="far fa-play-circle"></i> Started: ${formatDate(todo.started_at)}`;
    }
    
    if (todo.completed_at) {
        dateInfo += `<br><i class="far fa-check-circle"></i> Completed: ${formatDate(todo.completed_at)}`;
    }
    
    dateInfo += '</div>';
    
    let actions = '<div class="todo-item-actions">';
    
    if (status === 'TODO') {
        actions += `<button class="btn btn-warning btn-sm" onclick="updateTodoStatus(${todo.id}, 'ONGOING')">
            <i class="fas fa-play"></i> Start
        </button>`;
        actions += `<button class="btn btn-success btn-sm" onclick="updateTodoStatus(${todo.id}, 'DONE')">
            <i class="fas fa-check"></i> Done
        </button>`;
    } else if (status === 'ONGOING') {
        actions += `<button class="btn btn-success btn-sm" onclick="updateTodoStatus(${todo.id}, 'DONE')">
            <i class="fas fa-check"></i> Done
        </button>`;
        actions += `<button class="btn btn-secondary btn-sm" onclick="updateTodoStatus(${todo.id}, 'TODO')">
            <i class="fas fa-undo"></i> Back
        </button>`;
    } else if (status === 'DONE') {
        actions += `<button class="btn btn-warning btn-sm" onclick="updateTodoStatus(${todo.id}, 'ONGOING')">
            <i class="fas fa-redo"></i> Reopen
        </button>`;
    }
    
    actions += `<button class="btn btn-danger btn-sm" onclick="deleteTodo(${todo.id})">
        <i class="fas fa-trash"></i> Delete
    </button>`;
    actions += '</div>';
    
    return `
        <div class="todo-item" data-todo-id="${todo.id}">
            <div class="todo-item-title">${escapeHtml(todo.title)}</div>
            ${todo.description ? `<div class="todo-item-description">${escapeHtml(todo.description)}</div>` : ''}
            ${dateInfo}
            ${actions}
        </div>
    `;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function addTodo() {
    const title = document.getElementById('todoTitle').value.trim();
    const description = document.getElementById('todoDescription').value.trim();
    
    if (!title) {
        alert('Please enter a task title');
        return;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    fetch('{% url "create_todo" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            title: title,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addTodoModal'));
            modal.hide();
            
            // Clear form
            document.getElementById('todoTitle').value = '';
            document.getElementById('todoDescription').value = '';
            
            // Reload todos
            loadTodos();
            
            // Show success message
            showToast('Task added successfully!', 'success');
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error adding todo:', error);
        alert('Failed to add task');
    });
}

function updateTodoStatus(todoId, newStatus) {
    const csrftoken = getCookie('csrftoken');
    
    fetch(`/todos/${todoId}/update-status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadTodos();
            showToast('Task status updated!', 'success');
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error updating todo:', error);
        alert('Failed to update task');
    });
}

function deleteTodo(todoId) {
    if (!confirm('Are you sure you want to delete this task?')) {
        return;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    fetch(`/todos/${todoId}/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadTodos();
            showToast('Task deleted successfully!', 'success');
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error deleting todo:', error);
        alert('Failed to delete task');
    });
}

function showToast(message, type) {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Duty Delegation Functions
function loadStaffMembers() {
    const staffSelect = document.getElementById('dutyStaffMember');
    if (!staffSelect) return;
    
    staffSelect.innerHTML = '<option value="">Loading...</option>';
    fetch('{% url "get_staff_members" %}')
        .then(resp => resp.json())
        .then(data => {
            if (!data.success) throw new Error(data.message || 'Failed');
            staffSelect.innerHTML = '<option value="">Select Staff Member...</option>';
            data.members.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.id;
                option.textContent = staff.name;
                staffSelect.appendChild(option);
            });
        })
        .catch(err => {
            console.error('Error loading staff members:', err);
            staffSelect.innerHTML = '<option value="">Unable to load staff</option>';
        });
}

function delegateDuty() {
    const staffMember = document.getElementById('dutyStaffMember').value;
    const priority = document.getElementById('dutyPriority').value;
    const title = document.getElementById('dutyTitle').value.trim();
    const description = document.getElementById('dutyDescription').value.trim();
    const dueDate = document.getElementById('dutyDueDate').value;
    const dueTime = document.getElementById('dutyDueTime').value;
    
    if (!staffMember || !priority || !title || !description || !dueDate) {
        alert('Please fill in all required fields');
        return;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    const dutyData = {
        assigned_to_id: staffMember,
        priority: priority,
        title: title,
        description: description,
        due_date: dueDate
    };
    
    // Send to backend
    fetch('{% url "create_delegated_duty" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(dutyData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('delegateDutyModal'));
            modal.hide();
            
            // Clear form
            document.getElementById('delegateDutyForm').reset();
            
            showToast('Duty delegated successfully!', 'success');
            
            // Reload page to show new duty
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error delegating duty:', error);
        alert('Failed to delegate duty. Please try again.');
    });
}

function addDutyToTable(duty) {
    const tbody = document.getElementById('delegated-duties-list');
    
    // Remove empty state if exists
    if (tbody.querySelector('td[colspan="6"]')) {
        tbody.innerHTML = '';
    }
    
    const priorityClass = `priority-${duty.priority.toLowerCase()}`;
    const staffName = document.querySelector(`#dutyStaffMember option[value="${duty.staff_member}"]`)?.textContent || 'Unknown';
    
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <div class="d-flex align-items-center">
                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(staffName)}&background=4a6fa5&color=fff" 
                     class="rounded-circle me-2" width="32" height="32" alt="${staffName}">
                <div>${staffName}</div>
            </div>
        </td>
        <td>
            <strong>${escapeHtml(duty.title)}</strong>
            <br><small class="text-muted">${escapeHtml(duty.description).substring(0, 50)}...</small>
        </td>
        <td><span class="priority-badge ${priorityClass}">${duty.priority}</span></td>
        <td>${new Date(duty.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
        <td><span class="badge duty-status-pending">Pending</span></td>
        <td>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="viewDutyDetails(this)" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-outline-success" onclick="markDutyComplete(this)" title="Mark Complete">
                    <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="deleteDuty(this)" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    `;
    
    tbody.appendChild(row);
}

function viewDutyDetails(btn) {
    const row = btn.closest('tr');
    const staffName = row.cells[0].textContent.trim();
    const title = row.cells[1].querySelector('strong').textContent;
    alert(`Duty Details:\nStaff: ${staffName}\nTask: ${title}\n\n(Full details view would be implemented here)`);
}

function markDutyComplete(btn) {
    const row = btn.closest('tr');
    const statusBadge = row.querySelector('.badge');
    statusBadge.className = 'badge duty-status-completed';
    statusBadge.textContent = 'Completed';
    showToast('Duty marked as completed!', 'success');
}

function deleteDuty(btn) {
    if (!confirm('Are you sure you want to delete this duty?')) {
        return;
    }
    
    const row = btn.closest('tr');
    row.remove();
    
    // Check if table is empty
    const tbody = document.getElementById('delegated-duties-list');
    if (tbody.children.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-clipboard-list fa-2x mb-2 d-block"></i>
                    No duties assigned yet. Click "Assign New Duty" to get started.
                </td>
            </tr>
        `;
    }
    
    showToast('Duty deleted successfully!', 'success');
}

// Load staff members when modal is opened
document.addEventListener('DOMContentLoaded', function() {
    const delegateModal = document.getElementById('delegateDutyModal');
    if (delegateModal) {
        delegateModal.addEventListener('show.bs.modal', function() {
            loadStaffMembers();
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dutyDueDate').setAttribute('min', today);
        });
    }
});
</script>
{% endblock %}